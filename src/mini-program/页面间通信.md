# å·§å€ŸRxJSä¸œé£ï¼Œå®ç°Taroå°ç¨‹åºè·¨é¡µé¢é€šä¿¡

### å‰è¨€
----------
æœ€è¿‘æ­£åœ¨ä½¿ç”¨Taroå¼€å‘å°ç¨‹åºï¼Œé‡åˆ°äº†è®¸å¤šé—®é¢˜ï¼Œé¦–å…ˆé‡åˆ°çš„ä¾¿æ˜¯é¡µé¢é—´ä¼ é€’æ•°æ®çš„é—®é¢˜ï¼Œè®°å½•ä¸€ä¸‹è§£å†³çš„è¿‡ç¨‹å’Œæœ€åé‡‡å–çš„æ–¹æ¡ˆï¼Œä¹Ÿä¾›å¤§å®¶å‚è€ƒã€‚

### æ–¹æ¡ˆä¸€ (Taro.eventCenter) âŒ
----------

è·¨é¡µé¢é€šä¿¡ï¼Œé¦–å…ˆæƒ³åˆ°çš„ä¾¿æ˜¯æ¶ˆæ¯çš„æ–¹å¼ï¼Œå¥½åœ¨Taroæä¾›äº†ä¸€ä¸ªå…¨å±€æ¶ˆæ¯ä¸­å¿ƒ: Taro.eventCenterã€‚
ç”¨æ³•å¦‚ä¸‹ï¼š
```ts
Taro.eventCenter.on('eventName',handler) // ç›‘å¬ä¸€ä¸ªäº‹ä»¶ï¼Œæ¥å—å‚æ•°
Taro.eventCenter.trigger('eventName') // è§¦å‘ä¸€ä¸ªäº‹ä»¶ï¼Œä¼ å‚
Taro.eventCenter.off('eventName',handler) // å–æ¶ˆç›‘å¬ä¸€ä¸ªäº‹ä»¶æŸä¸ª handler
```
å¼€å§‹æ“ç»ƒèµ·æ¥

#### Aé¡µé¢è§¦å‘äº‹ä»¶
```tsx
await navigateTo({url: 'page B'}
Taro.eventCenter.trigger('eventName',data)
```
#### Bé¡µé¢ç›‘å¬äº‹ä»¶
```tsx
useEffect(() => {
  Taro.eventCenter.on('eventName', (data) => {
    // do something
  })
}, [])
```

ç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å¾ˆéª¨æ„Ÿï¼Œè¿™æ ·æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸ºåœ¨Aé¡µé¢äº‹ä»¶è§¦å‘ä¹‹åï¼ŒBé¡µé¢è¿˜æ²¡ç›‘å¬ä¸Šã€‚åˆ«æ€¥ï¼Œé‚£æˆ‘åŠ ä¸€ä¸ªsetTimeoutç­‰ä¸€ç­‰å‘¢?
```tsx
await navigateTo({url: 'page B'}
setTimeout(() => {
 Taro.eventCenter.trigger('eventName',data)
},200)
```
æµ‹è¯•æ˜¯å¯ä»¥ï¼ä½†è¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚æ–¹æ¡ˆä¸€è‡³æ­¤è¢«æ”¾å¼ƒã€‚

### æ€è€ƒğŸ¤”
-------------
ç„¶åæˆ‘ä»¬å†æ¥æ€è€ƒï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½åœ¨ç›‘å¬çš„æ—¶å€™å†å»æ¶ˆè´¹æ•°æ®å‘¢ï¼Ÿè¿™æ ·å°±éœ€è¦æ»¡è¶³ä¸¤ç‚¹è¦æ±‚ï¼š

- **Aé¡µé¢è·³è½¬çš„æ—¶å€™å…ˆå­˜å‚¨æ•°æ®**
- **Bé¡µé¢è®¢é˜…æ—¶å€™å†å»æ¶ˆè´¹æ•°æ®**

äºæ˜¯ä¹ï¼ŒRxJSä¸­çš„BehaviorSubjectçš„èº«å½±æ¸æ¸æµ®å‡ºæ°´é¢ã€‚

ä¸äº†è§£çš„åŒå­¦å¯ä»¥å…ˆçœ‹ä¸€ä¸‹ç›¸å…³ä»‹ç»ï¼š[BehaviorSubject](https://rxjs.dev/guide/subject#behaviorsubject)

### æ–¹æ¡ˆäºŒ (RxJS BehaviorSubject) âœ…
------------

å…ˆç®€å•ç†è§£ä¸¤ä¸ªå¯¹è±¡ï¼š
- Observableï¼Œå¯è§‚å¯Ÿå¯¹è±¡ï¼Œæ•°æ®ç”Ÿäº§è€… ï¼Œäº§ç”Ÿæ•°æ®çš„ä¸€æ–¹ã€‚

- Observerï¼Œè§‚å¯Ÿè€…ï¼Œæ•°æ®æ¶ˆè´¹è€… ï¼Œæ¥æ”¶æ•°æ®çš„ä¸€æ–¹ã€‚

å†æ¥è¯´**BehaviorSubject**ï¼š

æ—¢æ˜¯ç”Ÿäº§è€…åˆæ˜¯æ¶ˆè´¹è€…ï¼Œå®ƒæœ‰ä¸€ä¸ªâ€œå½“å‰å€¼â€çš„æ¦‚å¿µã€‚å®ƒä¿å­˜äº†å‘é€ç»™æ¶ˆè´¹è€…çš„æœ€æ–°å€¼ï¼Œå½“æœ‰æ–°çš„è§‚å¯Ÿè€…è®¢é˜…æ—¶ï¼Œä¼šç«‹å³ä» BehaviorSubject é‚£æ¥æ”¶åˆ°â€œå½“å‰å€¼â€ï¼Œåœ¨å®šä¹‰ä¸€ä¸ª BehaviorSubject æ—¶éœ€è¦æœ‰åˆå§‹å€¼ã€‚

ç”¨æ³•ï¼š

```tsx
import { BehaviorSubject } from 'rxjs';
const subject = new BehaviorSubject(0); // åˆ›å»ºï¼Œä¸€ä¸ªnumberç±»å‹çš„åˆå§‹å€¼
subject.subscribe({
  next: (v) => console.log(`observerA: ${v}`) // æ¶ˆè´¹æ•°æ®
});

subject.next(1);// ç”Ÿäº§æ•°æ®
subject.next(2);// ç”Ÿäº§æ•°æ®

subject.subscribe({
  next: (v) => console.log(`observerB: ${v}`) // æ¶ˆè´¹æ•°æ®
});

subject.next(3);

// æ‰“å°ç»“æœ
// observerA: 0  Aè®¢é˜…å½“å‰å€¼æ˜¯0ï¼Œåˆå§‹å€¼
// observerA: 1
// observerA: 2
// observerB: 2  Bè®¢é˜…å½“å‰å€¼æ˜¯2
// observerA: 3
// observerB: 3
```

ç»§ç»­æ“ç»ƒèµ·æ¥ï¼

#### å…ˆå®ç°ä¸¤ä¸ªæ–¹ä¾¿åˆ›å»ºå’Œè®¢é˜…BehaviorSubjectçš„hooks

- **useBehaviorSubject** ç”¨æ¥åˆ›å»º
```tsx
import { BehaviorSubject } from 'rxjs'
import { useConst } from 'whooks'

function useBehaviorSubject<T>(init: T) {
  const behaviorSubject = useConst(new BehaviorSubject<T>(init))
  useEffect(() => {
    return () => {
      behaviorSubject.unsubscribe()
    }
  }, [behaviorSubject])
  return behaviorSubject
}

export default useBehaviorSubject

```
å…¶ä¸­æœ‰ä¸ªuseConst,è¿˜æœ‰ä¸‹è¾¹ä½¿ç”¨çš„useConstCallback,æ˜¯æˆ‘è‡ªå·±å¸¸ç”¨çš„[hooks](https://www.npmjs.com/package/whooks),é‡Œè¾¹å°±æ˜¯ç”¨äº†ä¸‹refã€‚


- **useBehaviorSubscription** ç”¨æ¥æ¶ˆè´¹

```tsx
import type { BehaviorSubject } from 'rxjs'
function useBehaviorSubscription<T>(subject: BehaviorSubject<T>, next: (value: T) => void) {
  useEffect(() => {
    const subscription = subject.subscribe(next)
    return () => {
      subscription.unsubscribe()
    }
  }, [subject, next])
}
export default useBehaviorSubscription
```

#### åˆ›å»ºå…¨å±€countBehaviorSubject

ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªGlobalProvider,æŠŠcountBehaviorSubjectæ”¾åˆ°Contextä¸­

```tsx
const useGlobalProviderFacade = () => {
  const countBehaviorSubject = useBehaviorSubject(0)
  return {
    countBehaviorSubject
  }
}
export type GlobalContextType = ReturnType<typeof useGlobalProviderFacade>
export const GlobalContext = React.createContext<GlobalContextType>({} as GlobalContextType)
export const GlobalProvider: React.FC = ({ children }) => {
  const globalData = useGlobalProviderFacade()
  return <GlobalContext.Provider value={globalData}>{children}</GlobalContext.Provider>
}

export const useGlobal = useContext(GlobalContext)

```

å†æ¥çœ‹æ•ˆæœğŸ’¥
#### Aé¡µé¢å‘å¸ƒæ•°æ®
```tsx
const { countBehaviorSubject } = useGlobal()

const onCreated = async () => {
  countBehaviorSubject.next(1)
  await Taro.navigateTo({url: 'page B'})
}
```

#### Bé¡µé¢æ¶ˆè´¹æ•°æ®
```tsx
const { countBehaviorSubject } = useGlobal()
const next = useConstCallBack((value) => {
  // do something
})
useBehaviorSubscription(countBehaviorSubject, next)
```

ä½¿ç”¨ç»“æœï¼Œå¯è¡Œï¼Œè‡³æ­¤ï¼Œåœ¨é¡µé¢ä¸­è°ƒç”¨ç®€å•çš„å‡ è¡Œä»£ç å°±å¯ä»¥å®ç°è·¨é¡µé¢çš„é€šä¿¡äº†ã€‚
```tsx
const subject = useBehaviorSubject(init:T) // åˆ›å»º
subject.next(data:T) // å‘å¸ƒ
useBehaviorSubscription(subject,handle:(value:T)=> void) // è®¢é˜…
```

### æ€»ç»“
-----------
- å·§å€ŸRxJSçš„BehaviorSubjectçš„ä¸œé£ï¼Œè§£å†³äº†é¡µé¢çš„é€šä¿¡é—®é¢˜ã€‚
- è§£å†³é—®é¢˜çš„æ ¹æœ¬ç‚¹åœ¨è·³è½¬é¡µé¢ä¹‹å‰æŠŠç”Ÿäº§çš„æ•°æ®å­˜å‚¨äº†èµ·æ¥ï¼Œåœ¨è·³è½¬åçš„é¡µé¢ä¸­å®ç°è®¢é˜…æ—¶å†æ¶ˆè´¹ã€‚
- åœ¨åè¾¹çš„è‡ªå®šä¹‰å¸¦æƒé™çš„tabBarçš„è¿‡ç¨‹ä¸­ä¹Ÿç”¨åˆ°äº†è¿™ä¸ªï¼Œå¯¹ä¸ªäººæ¥è®²è¿˜æ˜¯æ¯”è¾ƒä¾¿åˆ©çš„ã€‚
### æœ€å
-----------

- ç¬¬ä¸€æ¬¡åšå°ç¨‹åºçš„é¡¹ç›®ï¼Œä¹Ÿæ²¡ä»€ä¹ˆç»éªŒï¼Œè€ƒè™‘åˆ°å¼€å‘æ•ˆç‡ï¼Œç›´æ¥å°±ç”¨Taroäº†ã€‚
- è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¹Ÿèµ°äº†å¼¯è·¯ï¼Œå¤§å®¶æœ‰ä»€ä¹ˆå¥½çš„æ–¹æ¡ˆä¹Ÿå¯ä»¥æä¾›ä¸€ä¸‹ã€‚
- æœ€åï¼Œè¿˜æ˜¯å¸Œæœ›èƒ½ç»™ç¬¬ä¸€æ¬¡ç”¨Taroåšå°ç¨‹åºé‡åˆ°åŒæ ·é—®é¢˜çš„åŒå­¦æä¾›ä¸€äº›æ€è·¯ã€‚